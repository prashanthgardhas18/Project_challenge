CREATE WAREHOUSE INTERVIEW_WH WITH WAREHOUSE_SIZE = 'LARGE' WAREHOUSE_TYPE = 'STANDARD' AUTO_SUSPEND = 600 AUTO_RESUME = TRUE MIN_CLUSTER_COUNT = 1 MAX_CLUSTER_COUNT = 2 SCALING_POLICY = 'STANDARD';



CREATE DATABASE USER_PRASHANTHGARDHAS;



CREATE SCHEMA "USER_PRASHANTHGARDHAS"."MY_SCHEMA";



CREATE STAGE "USER_PRASHANTHGARDHAS"."MY_SCHEMA".airlines_stage URL = 's3://aws-external-stage-bucket/airlines/airlines.csv' CREDENTIALS = (AWS_KEY_ID = 'AKIASODD2CZDUV4ECWYA' AWS_SECRET_KEY = '****************************************');



CREATE STAGE "USER_PRASHANTHGARDHAS"."MY_SCHEMA".airports_stage URL = 's3://aws-external-stage-bucket/airlines/airlines.csv' CREDENTIALS = (AWS_KEY_ID = 'AKIASODD2CZDUV4ECWYA' AWS_SECRET_KEY = '****************************************');



CREATE STAGE "USER_PRASHANTHGARDHAS"."MY_SCHEMA".flights_stage URL = 's3://aws-external-stage-bucket/airlines/airlines.csv' CREDENTIALS = (AWS_KEY_ID = 'AKIASODD2CZDUV4ECWYA' AWS_SECRET_KEY = '****************************************');



CREATE FILE FORMAT "USER_PRASHANTHGARDHAS"."MY_SCHEMA".my_file_format TYPE = 'CSV' COMPRESSION = 'AUTO' FIELD_DELIMITER = ',' RECORD_DELIMITER = '\n' SKIP_HEADER = 1 FIELD_OPTIONALLY_ENCLOSED_BY = 'NONE' TRIM_SPACE = TRUE ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE ESCAPE = 'NONE' ESCAPE_UNENCLOSED_FIELD = '\134' DATE_FORMAT = 'AUTO' TIMESTAMP_FORMAT = 'AUTO' NULL_IF = ('\\N');



copy into airlines
from @airlines_stage
file_format = (format_name = 'my_file_format');


copy into airports
from @airports_stage
file_format = (format_name = 'my_file_format');


copy into flights
from @flights_stage
file_format = (format_name = 'my_file_format');


create view report_1 AS
SELECT a.AIRLINE, c.AIRPORT, a.MONTH, COUNT(*) AS Number_of_flights
FROM FLIGHTS a 
JOIN AIRPORTS c ON a.DESTINATION_AIRPORT = c.iata_code 
GROUP BY a.AIRLINE, c.AIRPORT, a.MONTH;


create view report_2 AS
WITH TOTAL AS (
SELECT COUNT(*) AS TOTAL_NO_OF_FLIGHTS
    FROM FLIGHTS
WHERE YEAR = 2015 )
SELECT a.AIRLINE,(COUNT(*) / b.TOTAL_NO_OF_FLIGHTS * 100) AS PERCENTAGE
FROM FLIGHTS a, TOTAL b
WHERE a.year = 2015
GROUP BY a.AIRLINE, b.TOTAL_NO_OF_FLIGHTS;



create view report_3 AS
SELECT a.airline,a.departure_delay FROM 
    (SELECT airline, departure_delay,row_number() over(PARTITION BY airline ORDER BY departure_delay DESC) as rnk
        FROM flights
    WHERE departure_delay IS NOT NULL
    )a
WHERE a.rnk = 1;



create view report_4 AS
SELECT * FROM 
    (SELECT a.airport,
             CASE WHEN b.cancellation_reason = 'A' THEN 'Airline/Carrier'
                  WHEN b.cancellation_reason = 'B' THEN 'Weather'
                  WHEN b.cancellation_reason = 'C' THEN 'National Air System'
                  WHEN b.cancellation_reason = 'D' THEN 'Security'
             END AS cancellation_reason,
            count(*) as total
     FROM airports a
        JOIN flights b 
        ON a.iata_code = b.origin_airport
   WHERE b.cancellation_reason IS NOT NULL
   GROUP BY a.airport, b.cancellation_reason
    )a;



create view report_5 AS
SELECT * FROM 
    (SELECT a.airport,
            sum(b.air_system_delay) as air_system_delay,
            sum(b.security_delay) as security_delay,
            sum(b.airline_delay) as airline_delay,
            sum(b.late_aircraft_delay) as late_aircraft_delay,
            sum(b.weather_delay) as weather_delay
     FROM airports a
        JOIN flights b 
        ON a.iata_code = b.origin_airport
     GROUP BY a.airport
    )a;

    

create view report_6 AS
SELECT airline,origin_airport, destination_airport FROM 
    (SELECT airline,origin_airport, destination_airport, 
            row_number() over(PARTITION BY airline, origin_airport, destination_airport
                 ORDER BY  origin_airport DESC) AS rnk
FROM flights)a
WHERE a.rnk = 1;